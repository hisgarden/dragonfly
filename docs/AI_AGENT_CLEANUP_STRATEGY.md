# AI Agent Artifact Cleanup Strategy

## Overview

DragonFly focuses on cleaning up artifacts generated by AI agents (like Cursor, GitHub Copilot, Claude Desktop, etc.) that accumulate over time and clutter macOS systems. This document outlines the strategy for safe cleanup with recovery capabilities.

## Problem Statement

AI agents generate various artifacts during operation:
- **Git repositories** with large histories and object databases
- **Cache files** from language servers, models, and tools
- **Xcode derived data** and build artifacts
- **Homebrew** cache and temporary files
- **Time Machine snapshots** that accumulate on local disks
- **Node modules** and package caches
- **Python virtual environments** and pip caches
- **Docker images** and containers
- **LLM model files** and embeddings

These can consume **hundreds of GB** over time, especially with multiple AI tools running simultaneously.

## Cleanup Strategy

### 1. Safe Cleanup with Recovery

#### Core Principle: **Never Delete, Always Archive**

Instead of permanent deletion, DragonFly implements a **recovery-first** approach:

1. **Archive Before Cleanup**
   - Move files to a recovery location (`~/.dragonfly/recovery/`)
   - Create metadata manifest (JSON) with:
     - Original path
     - Size
     - Timestamp
     - Checksum (for verification)
     - Source (which AI agent/tool)

2. **Retention Policy**
   - Keep archives for configurable period (default: 30 days)
   - Automatic cleanup of old archives after retention period
   - User can restore anytime before expiration

3. **Verification**
   - Calculate checksums before archiving
   - Verify integrity on restore
   - Track what was cleaned and when

### 2. Target Categories

#### A. Git Artifacts
**Locations:**
- `~/.gitconfig` (backup only, don't delete)
- `~/.git-credentials` (backup only)
- `~/.gitignore_global` (backup only)
- `**/.git/objects/pack/` (large pack files)
- `**/.git/refs/` (can be regenerated)
- `**/.git/logs/` (can be regenerated)

**Strategy:**
- Archive large pack files (>100MB) older than 90 days
- Keep refs and logs for active repos
- Provide `git gc` alternative (safer than deletion)

#### B. Cache Files
**Locations:**
- `~/Library/Caches/com.todesktop.230313mzl4w4u92/` (Cursor)
- `~/Library/Caches/com.github.GitHubCopilot/` (GitHub Copilot)
- `~/Library/Caches/com.anthropic.Claude/` (Claude Desktop)
- `~/Library/Caches/com.cursor.*/` (Cursor variants)
- `~/.cache/` (various tools)
- `~/Library/Application Support/*/Cache/` (app-specific)

**Strategy:**
- Archive cache files older than 7 days
- Keep recent caches for performance
- Track cache sizes per application

#### C. Xcode Artifacts
**Locations:**
- `~/Library/Developer/Xcode/DerivedData/` (build artifacts)
- `~/Library/Developer/Xcode/Archives/` (old archives)
- `~/Library/Developer/Xcode/iOS DeviceSupport/` (device support files)
- `~/Library/Developer/Xcode/Products/` (old products)

**Strategy:**
- Archive DerivedData older than 30 days
- Archive old Archives (>90 days)
- Keep recent builds for active projects
- Provide Xcode-specific cleanup commands

#### D. Homebrew Artifacts
**Locations:**
- `~/Library/Caches/Homebrew/` (download cache)
- `/opt/homebrew/var/cache/` (formula cache)
- `~/.brew/` (legacy location)

**Strategy:**
- Use `brew cleanup` first (official method)
- Archive old cache files (>30 days)
- Track what can be re-downloaded

#### E. Time Machine Snapshots
**Locations:**
- Local snapshots on APFS volumes
- Managed by `tmutil` command

**Strategy:**
- List all snapshots with `tmutil listlocalsnapshots`
- Identify snapshots older than threshold (default: 7 days)
- Use `tmutil deletelocalsnapshot` for safe deletion
- Provide snapshot size analysis
- Warn before deleting (snapshots are valuable!)

#### F. Node.js Artifacts
**Locations:**
- `~/.npm/` (npm cache)
- `~/.yarn/` (yarn cache)
- `~/.pnpm-store/` (pnpm cache)
- `**/node_modules/` (dependencies)

**Strategy:**
- Archive npm/yarn/pnpm caches older than 30 days
- Identify large `node_modules` directories
- Provide `npm cache clean` alternative
- Track package manager usage

#### G. Python Artifacts
**Locations:**
- `~/.cache/pip/` (pip cache)
- `~/.pyenv/versions/` (old Python versions)
- `**/__pycache__/` (bytecode cache)
- `**/.venv/` (virtual environments)

**Strategy:**
- Archive pip cache older than 30 days
- Identify unused virtual environments
- Clean `__pycache__` directories
- Track Python version usage

#### H. Docker Artifacts
**Locations:**
- Docker images, containers, volumes
- Managed via Docker CLI

**Strategy:**
- Use `docker system prune` (official method)
- Archive old images before deletion
- Track Docker disk usage

#### I. LLM Model Files
**Locations:**
- `~/.cache/huggingface/` (Hugging Face models)
- `~/.ollama/models/` (Ollama models)
- `~/Library/Application Support/ollama/` (Ollama data)
- `~/.local/share/` (various model locations)

**Strategy:**
- **CAUTION**: Models are expensive to re-download
- Only archive if explicitly requested
- Track model sizes and last usage
- Provide model management interface

### 3. Recovery System

#### Recovery Location Structure
```
~/.dragonfly/
├── recovery/
│   ├── manifests/
│   │   ├── 2025-01-20_14-30-00_cleanup.json
│   │   └── ...
│   ├── archives/
│   │   ├── 2025-01-20_14-30-00/
│   │   │   ├── git-packs.tar.gz
│   │   │   ├── xcode-derived.tar.gz
│   │   │   └── ...
│   │   └── ...
│   └── index.json  # Master index of all recoveries
└── config.json     # DragonFly configuration
```

#### Manifest Format
```json
{
  "id": "2025-01-20_14-30-00",
  "timestamp": "2025-01-20T14:30:00Z",
  "total_size": 15728640000,
  "items": [
    {
      "original_path": "~/Library/Caches/com.todesktop.230313mzl4w4u92/cache.db",
      "archive_path": "recovery/archives/2025-01-20_14-30-00/cursor-cache.tar.gz",
      "size": 104857600,
      "checksum": "sha256:abc123...",
      "category": "cache",
      "source": "Cursor",
      "can_regenerate": true
    }
  ],
  "retention_until": "2025-02-19T14:30:00Z"
}
```

### 4. Implementation Plan

#### Phase 1: Core Recovery System
1. Create recovery directory structure
2. Implement manifest generation
3. Implement archive creation
4. Implement restore functionality
5. Add retention policy enforcement

#### Phase 2: Target-Specific Cleaners
1. Git artifact cleaner
2. Cache cleaner (AI agent specific)
3. Xcode cleaner
4. Homebrew cleaner
5. Time Machine snapshot manager

#### Phase 3: Advanced Features
1. Interactive restore interface
2. Size analysis and reporting
3. Automatic cleanup scheduling
4. Integration with Time Machine
5. Model file management

### 5. Commands

#### Cleanup Commands
```bash
# Clean AI agent artifacts
dragonfly clean --ai-agents

# Clean specific category
dragonfly clean --git-artifacts
dragonfly clean --xcode-artifacts
dragonfly clean --brew-artifacts
dragonfly clean --time-machine-snapshots

# Dry run (preview what would be cleaned)
dragonfly clean --ai-agents --dry-run

# Custom retention period
dragonfly clean --ai-agents --retention-days 60
```

#### Recovery Commands
```bash
# List available recoveries
dragonfly recover list

# Show details of a recovery
dragonfly recover show 2025-01-20_14-30-00

# Restore a recovery
dragonfly recover restore 2025-01-20_14-30-00

# Restore specific items
dragonfly recover restore 2025-01-20_14-30-00 --items cursor-cache

# Clean up old recoveries
dragonfly recover cleanup --older-than 30d
```

#### Analysis Commands
```bash
# Analyze disk usage by category
dragonfly analyze --ai-artifacts

# Show Time Machine snapshot sizes
dragonfly time-machine snapshots --size

# Show cache sizes per application
dragonfly analyze --cache-sizes
```

### 6. Safety Features

#### Pre-Cleanup Checks
- Check disk space (ensure enough for archive)
- Verify write permissions
- Check if files are in use
- Warn about large operations

#### Post-Cleanup Verification
- Verify archive integrity
- Calculate space freed
- Update recovery index
- Log all operations

#### Recovery Verification
- Verify checksums before restore
- Check destination space
- Warn about overwriting existing files
- Provide rollback option

### 7. Time Machine Integration

#### Snapshot Management
- List all local snapshots
- Show snapshot sizes
- Identify old snapshots
- Safe deletion with `tmutil`
- Integration with Time Machine preferences

#### Best Practices
- Keep recent snapshots (last 7 days)
- Delete old snapshots on local disk
- Rely on Time Machine backups for long-term
- Warn before deleting all snapshots

### 8. Configuration

#### Config File (`~/.dragonfly/config.json`)
```json
{
  "recovery": {
    "enabled": true,
    "location": "~/.dragonfly/recovery",
    "retention_days": 30,
    "compression": true
  },
  "targets": {
    "git": {
      "enabled": true,
      "min_age_days": 90,
      "min_size_mb": 100
    },
    "cache": {
      "enabled": true,
      "min_age_days": 7,
      "applications": ["Cursor", "GitHubCopilot", "Claude"]
    },
    "xcode": {
      "enabled": true,
      "derived_data_age_days": 30,
      "archives_age_days": 90
    },
    "brew": {
      "enabled": true,
      "min_age_days": 30
    },
    "time_machine": {
      "enabled": true,
      "snapshot_age_days": 7,
      "warn_before_delete": true
    }
  },
  "safety": {
    "require_confirmation": true,
    "max_single_operation_gb": 50,
    "check_disk_space": true
  }
}
```

### 9. User Experience

#### Interactive Mode
- Show what will be cleaned
- Ask for confirmation
- Show progress
- Display summary

#### Non-Interactive Mode
- JSON output for scripting
- Log all operations
- Return exit codes
- Support dry-run

### 10. Monitoring and Reporting

#### Metrics Tracked
- Total space freed
- Items cleaned per category
- Recovery success rate
- Average cleanup time
- Disk usage trends

#### Reports
- Daily cleanup summary
- Weekly space analysis
- Monthly trends report
- Recovery usage statistics

---

## Implementation Priority

1. **High Priority**
   - Core recovery system
   - Git artifacts cleanup
   - Cache cleanup (AI agents)
   - Time Machine snapshot management

2. **Medium Priority**
   - Xcode cleanup
   - Homebrew cleanup
   - Node.js/Python cleanup

3. **Low Priority**
   - Docker cleanup
   - LLM model management
   - Advanced analytics

---

## References

- [Time Machine Snapshot Management](https://support.apple.com/en-us/HT204015)
- [Git Garbage Collection](https://git-scm.com/docs/git-gc)
- [Homebrew Cleanup](https://docs.brew.sh/Manpage#cleanup-options)
- [Xcode Derived Data](https://developer.apple.com/documentation/xcode/managing-your-projects-settings-and-data)
